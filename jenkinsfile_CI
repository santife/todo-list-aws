pipeline {
    agent any
    stages {
        stage ('Get Code'){
            steps {
                //Optenemos el codigo de nuestro Git
                git url: 'https://github.com/santife/todo-list-aws.git', branch:'develop'
                
            }
        }
        
       
        
        stage ('Static Test'){
            steps{
                sh '''
                    export PYTHONPATH=$(pwd)
                    flake8 --exit-zero --format=pylint src >flake8.out
                '''
                recordIssues tools: [flake8(name: 'Flake8', pattern: 'flake8.out')], qualityGates: [[threshold: 8, type: 'TOTAL', unstable: false], [threshold: 10, type: 'TOTAL', unsatble: false]]
            
               
            
            }
        }
        
        stage ('SAM Deply'){
            steps{
                sh 'sam build'
                //sh 'sam deploy --stack-name "todo-list-aws" --region "us-east-1" --config-env staging --no-fail-on-empty-changeset  --force-upload --resolve-s3'
                sh 'sam deploy --stack-name todo-list-aws --resolve-s3 --region us-east-1 --no-fail-on-empty-changeset --force-upload --config-env staging'
                script{
                    def BASE_URL = sh( script: "aws cloudformation describe-stacks --stack-name todo-list-aws --query Stacks[0].Outputs[0].OutputValue --output text")
                    echo "$BASE_URL"
                }
                sh'''                    
                    BASE_URL=$(aws cloudformation describe-stacks --stack-name todo-list-aws --query "Stacks[0].Outputs[0].OutputValue" --output text)
                    echo $BASE_URL
                '''
                
            }
        }
        
        stage ('Rest Test'){
            steps{
              echo 'En Construccion'
              sh 'echo $BASE_URL'
            }
        }
        
        stage ('Promote'){
            steps{
                echo 'En construccion'
                cleanWs()
            }
        }
    }
}
